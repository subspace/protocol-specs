<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-decex/workflow" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Workflow | Subspace Protocol</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://subspace.github.io/protocol-specs/docs/decex/workflow"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Workflow | Subspace Protocol"><meta data-rh="true" name="description" content="Complete workflow of domain operation."><meta data-rh="true" property="og:description" content="Complete workflow of domain operation."><meta data-rh="true" name="keywords" content="execution,decex,instantiation"><link data-rh="true" rel="icon" href="/protocol-specs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://subspace.github.io/protocol-specs/docs/decex/workflow"><link data-rh="true" rel="alternate" href="https://subspace.github.io/protocol-specs/docs/decex/workflow" hreflang="en"><link data-rh="true" rel="alternate" href="https://subspace.github.io/protocol-specs/docs/decex/workflow" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://DQOBF9R1M4-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Subspace Protocol" href="/protocol-specs/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/protocol-specs/assets/css/styles.006e31aa.css">
<script src="/protocol-specs/assets/js/runtime~main.4baf4132.js" defer="defer"></script>
<script src="/protocol-specs/assets/js/main.10a979d7.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?t("light"):t("dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/protocol-specs/"><div class="navbar__logo"><img src="/protocol-specs/img/logo-black.svg" alt="Subspace Labs Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/protocol-specs/img/logo-white.svg" alt="Subspace Labs Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/protocol-specs/docs/protocol_specifications">Specifications</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Network Resources</a><ul class="dropdown__menu"><li><a href="https://explorer.subspace.network/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Subspace Explorer<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://telemetry.subspace.network" target="_blank" rel="noopener noreferrer" class="dropdown__link">Subspace Telemetry<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://polkadot.js.org/apps/?rpc=wss%3A%2F%2Feu-1.gemini-2a.subspace.network%2Fws#/explorer" target="_blank" rel="noopener noreferrer" class="dropdown__link">PolkadotJS Portal<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://docs.subspace.network" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Documentation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/subspace" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/protocol-specs/docs/protocol_specifications">Protocol Specifications</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/protocol-specs/docs/crypto_primitives">Cryptographic Primitives</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/protocol-specs/docs/category/consensus">Consensus</a><button aria-label="Expand sidebar category &#x27;Consensus&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/protocol-specs/docs/category/decoupled-execution">Decoupled Execution</a><button aria-label="Collapse sidebar category &#x27;Decoupled Execution&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/protocol-specs/docs/decex/overview">Domains Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/protocol-specs/docs/decex/interfaces">Domains Interfaces</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/protocol-specs/docs/decex/bundles_blocks">Bundles and Domain Blocks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/protocol-specs/docs/decex/workflow">Workflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/protocol-specs/docs/decex/staking">Staking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/protocol-specs/docs/decex/fraud_proofs">Fraud Proofs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/protocol-specs/docs/decex/xdm">Cross-Domain Messaging (XDM)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/protocol-specs/docs/category/fees-and-rewards">Fees and Rewards</a><button aria-label="Expand sidebar category &#x27;Fees and Rewards&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/protocol-specs/docs/runtime">Runtime</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/protocol-specs/docs/glossary">Glossary</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/protocol-specs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/protocol-specs/docs/category/decoupled-execution"><span itemprop="name">Decoupled Execution</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Workflow</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Workflow</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="domain-instantiation--upgrades">Domain Instantiation &amp; Upgrades<a href="#domain-instantiation--upgrades" class="hash-link" aria-label="Direct link to Domain Instantiation &amp; Upgrades" title="Direct link to Domain Instantiation &amp; Upgrades">​</a></h2>
<p>When a new domain is instantiated, the consensus runtime generates a genesis ER hash using the <code>genesis_config</code> and <code>domain_config</code> for that domain.</p>
<p>The consensus chain will initiate a “balance” for this domain to track how many SSC were transferred in and out of this domain to make sure a domain cannot create SSC it did not already have via fees, XDM transfers or storage fee deposits. This balance does not include staked SSC as staking is tracked on the consensus chain directly.</p>
<p><code>genesis_receipt_hash</code> is derived using a host function call passing the required genesis <code>domain_config</code> details mentioned below. The host function will construct the <code>DomainConfig</code> using the domain runtime and create the genesis ER by deriving the <code>genesis_state_root</code>, presented <a href="https://github.com/paritytech/substrate/blob/689da495a0c0c0c2466fe90a9ea187ce56760f2d/client/chain-spec/src/genesis.rs#L134" target="_blank" rel="noopener noreferrer">here</a>, and returning the <code>genesis_receipt_hash</code>. This ER will not have any intermediate state roots, but only the final state root, as Genesis ER is considered special.</p>
<p>Operators who want to run this domain will create a genesis block using the <code>GenesisConfig</code> placed on the consensus chain during domain instantiation and construct the genesis ER used when submitting the next block’s ER thereby building a block tree.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="domain-instance-genesis-block-generation">Domain Instance Genesis Block Generation<a href="#domain-instance-genesis-block-generation" class="hash-link" aria-label="Direct link to Domain Instance Genesis Block Generation" title="Direct link to Domain Instance Genesis Block Generation">​</a></h2>
<p>When the domain is first instantiated in the consensus runtime, a <code>genesis_state_root</code> is derived using a host function with <code>domain_config</code> as input, the <code>genesis_state_root</code> will be further used to drive a genesis ER which will not have any intermediate state roots, only the final state root, as Genesis ER is considered special.</p>
<p>The <code>genesis_state_root</code> is required to be unique among all domain instances and consistent with the <code>genesis_state_root</code> generated by the domain instance node on the client side. The host function and the domain instance node derive <code>genesis_state_root</code> by generating a genesis block with <code>RuntimeGenesisConfig</code> as input, thus, to achieve uniqueness and consistency, the <code>RuntimeGenesisConfig</code> needs to be unique and consistent.</p>
<p>For all domain runtime types, <code>RuntimeGenesisConfig</code> should include the pallet genesis config of:</p>
<ul>
<li>system pallet <code>SystemConfig { code }</code> for it to be a valid <code>RuntimeGenesisConfig</code></li>
<li>domain-id pallet  <code>DomainIdConfig { domain_id }</code> for it to be unique as it includes a unique <code>domain_id</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="domain-instance-node-bootstrap">Domain Instance Node Bootstrap<a href="#domain-instance-node-bootstrap" class="hash-link" aria-label="Direct link to Domain Instance Node Bootstrap" title="Direct link to Domain Instance Node Bootstrap">​</a></h2>
<p>After the operator instantiated a domain instance at the consensus chain by submitting an <code>instantiate_domain</code> extrinsic and waiting until the extrinsic is finalized (past the <code>CONFIRMATION_DEPTH_K</code> consensus blocks), the operator can use the resulting domain instance <code>domain_id</code> and <code>created_at</code> (block height) arguments to the <code>subspace-node</code> binary to run a domain instance node for the instantiated domain.</p>
<p>The domain instance node has two modes: bootstrap mode and sync mode. In the bootstrap mode, the node must bootstrap the domain instance chain by itself based on the domain registry state at the consensus chain. The node can sync the chain from other domain instance nodes in sync mode.</p>
<p>In bootstrap mode, there is an embedded consensus node and a bootstrapper. After the bootstrap is finished, a domain node will replace the bootstrapper.</p>
<p>The bootstrapper listens to the consensus node block import event, skips the block before <code>created_at</code>, after the block at <code>created_at</code> is imported, which contains the <code>instantiate_domain</code> extrinsic of the domain instance, using runtime API with <code>domain_id</code> to get the domain instance’s <code>domain_config</code> and the <code>runtime_obj</code> state.</p>
<p>Uses the <code>domain_config</code> and <code>runtime_obj.domain_runtime_code</code> to generate a <code>RuntimeGenesisConfig</code> in the same way as <a href="#domain-instance-genesis-block-generation">the host function</a>, and uses that to construct <code>sc_service::Configuration</code> (which includes the <code>chain_spec</code>) then use <code>runtime_obj.runtime_type</code> to determine and build the desired domain service with <code>sc_service::Configuration</code> as input. After this step the domain service is up and the bootstrap is finished.</p>
<div class="collapsible"><button class="collapsible-toggle">►<!-- --> <!-- -->Note</button><div class="collapsible-content"></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="domain-genesis-config">Domain Genesis Config<a href="#domain-genesis-config" class="hash-link" aria-label="Direct link to Domain Genesis Config" title="Direct link to Domain Genesis Config">​</a></h2>
<p>The <code>domain_config</code> contains:</p>
<ol>
<li><code>domain_name</code>: user-defined name for this domain.</li>
<li><code>runtime_id</code>: domain runtime type that exists in <code>RuntimeRegistry</code>.</li>
<li><code>domain_id</code>: identifier assigned to an instance of the domain.</li>
<li>specific configuration items, such as:<!-- -->
<ul>
<li><code>bundle_slot_probability</code>: the number of successful bundle expected to be produced in a slot (active slots coefficient); defines the expected number of bundles in the consensus block. Must be <code>&gt; 0</code> and <code>&lt;= 1</code>, recommended value <code>1</code> .</li>
<li><code>max_bundle_size</code>: the max bundle size for this domain; may not exceed the system-wide <code>MaxDomainBlockSize</code> limit; The average domain block size is then expected to be below <code>bundle_slot_probability * max_bundle_size / SLOT_PROBABILITY</code> on average.</li>
<li><code>max_bundle_weight</code>: the max bundle weight for this domain; may not exceed the system-wide <code>MaxDomainBlockWeight</code> limit; The average domain block weight is then expected to be below <code>bundle_slot_probability * max_bundle_weight / SLOT_PROBABILITY</code> on average.</li>
</ul>
</li>
<li><code>allowlist</code>: list of addresses allowed to run operators on this domain</li>
<li><code>initial_balances</code>: list of initial balances on domain accounts</li>
<li>Any further genesis config details can be included as required and be passed down. These specific genesis details ensure the <code>genesis_state_root</code> is unique for each instantiated domain and thereby making <code>genesis_er_hash</code> unique across different instances of the same domain runtime.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="domain-runtime-upgrades">Domain Runtime Upgrades<a href="#domain-runtime-upgrades" class="hash-link" aria-label="Direct link to Domain Runtime Upgrades" title="Direct link to Domain Runtime Upgrades">​</a></h2>
<p>When a domain runtime is updated using <code>upgrade_domain_runtime</code>, the new runtime will come into effect at a future consensus chain block, specifically, the block at which the extrinsic <code>upgrade_domain_runtime</code> was executed successfully and <code>DomainRuntimeUpgradeDelay</code> blocks have passed since. When that future block height arrives, the consensus chain considers the new runtime to be the latest runtime and adds a digest log to indicate the upgrade to all domain operators.</p>
<p>Since every operator runs the consensus chain, they will include the new runtime as part of the next domain block taken from the consensus chain, since they see the digest log in the consensus block header.</p>
<p>There are some scenarios where new runtime may introduce the new host APIs that newer clients will use during any stage of bundle production and block import. If the operators still use the older clients, they won’t be able to proceed and the clients are supposed to panic due to the usage of missing host APIs in the new runtime. Hence, every operator would be forced to update the client in this case. The upgrade process involves running the latest client in place of the older client. While it&#x27;s not strictly necessary, it would be beneficial to automatically signal the outdated client to operators later.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bundle-producer-election">Bundle Producer Election<a href="#bundle-producer-election" class="hash-link" aria-label="Direct link to Bundle Producer Election" title="Direct link to Bundle Producer Election">​</a></h2>
<p>For each time slot, each operator denoted with <code>operator_id</code> participates in the slot leader election for the domain <code>domain_id</code> they are staking on to determine whether they are eligible to produce a bundle in this slot, as follows:</p>
<ol>
<li><strong>Initialization</strong>
<ol>
<li>Get the <code>global_challenge</code> for this slot from the Proof-of-Time chain.</li>
<li>Retrieve <code>secret_key</code> from keystore.</li>
</ol>
</li>
<li><strong>VRF</strong>
<ol>
<li>Make <code>transcript</code> for the VRF from the <code>global_challenge</code> and VRF label for this <code>domain_id</code>.</li>
<li>Generate a VRF signature by applying the VRF to the <code>global_challenge</code> and the operator&#x27;s private key as <code>vrf_signature = vrf_sign(secret_key, transcript)</code>. The VRF signature contains a <code>vrf_signature.proof</code>, which can be used by others to verify that the VRF <code>vrf_signature.output</code> was correctly generated without knowing the operator’s private key.</li>
</ol>
</li>
<li><strong>Threshold Check</strong>
<ol>
<li>Compute the <code>threshold</code> based on the operators <code>operator_stake = current_total_stake</code> in <code>Operators</code> registry for this domain proportionally to the <code>total_domain_stake = current_total_stake</code> of all operators of this domain in <code>stake_summary</code> of the <code>DomainRegistry</code> as
<code>threshold = MAX * (operator_stake / total_domain_stake) * bundle_slot_probability</code>
<ul>
<li>
<p>Example</p>
<p>If <code>threshold</code> is stored in <code>u128</code>, then <code>MAX</code> is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>128</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{128}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">128</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span>. If the operator has <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mn>10</mn></mrow><annotation encoding="application/x-tex">1/10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">1/10</span></span></span></span> of total stake in this domain, according to the formula above they should check whether their VRF output numeric values is below <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>128</mn></msup><mi mathvariant="normal">/</mi><mn>10</mn></mrow><annotation encoding="application/x-tex">2^{128}/10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">128</span></span></span></span></span></span></span></span></span><span class="mord">/10</span></span></span></span>.</p>
</li>
</ul>
</li>
<li>Check whether the VRF <code>vrf_signature.output</code> for a slot is strictly below (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="#cc0000"><mtext>\&lt;</mtext></mstyle></mrow><annotation encoding="application/x-tex">\&lt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord text" style="color:#cc0000"><span class="mord" style="color:#cc0000">\&lt;</span></span></span></span></span>) the <code>threshold</code> as integers.</li>
<li>If it is, the operator is a slot leader for that slot and can produce a bundle. They should generate a <code>ProofOfElection</code>.</li>
<li>If it isn’t, they skip this slot</li>
</ol>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="domain-bundle-production">Domain Bundle Production<a href="#domain-bundle-production" class="hash-link" aria-label="Direct link to Domain Bundle Production" title="Direct link to Domain Bundle Production">​</a></h2>
<p>If, for this time slot, this operator was successfully elected a slot leader, they can produce a bundle (as <a href="/protocol-specs/docs/decex/bundles_blocks#bundles">defined</a>) as follows:</p>
<ol>
<li>
<p>Take the <code>ProofOfElection</code> of the slot leader.</p>
</li>
<li>
<p>Fetch the <code>ExecutionReceipt</code> for the last block executed locally from the domain client and attach it to the bundle header. This <code>ExecutionReceipt</code> must be based on the longest branch of the consensus chain, although it may not point to the tip of the chain, as this depends on when the last bundle for this domain was included in a consensus chain block. If there was a fraud detected at the same height, the locally produced <code>ExecutionReceipt</code> (if valid) will be replacing the fraudulent one in the BlockTree.</p>
</li>
<li>
<p>Attach the full <code>execution_trace</code> to the given <code>ExecutionReceipt</code></p>
</li>
<li>
<p>Grab all extrinsics within the specified <a href="#transaction-selection-for-bundle-production">range</a> <code>tx_range</code> and attach to the body.</p>
<p>If there is no extrinsic, the operator will skip producing a bundle and the following steps (TODO when challenge period is redefined in consensus blocks.)</p>
<p>(Currently) If there is no extrinsic, the operator will further look into the block tree</p>
<ol>
<li>If all domain blocks in the challenge period are empty blocks then the operator will skip producing an empty bundle thus skipping the following steps</li>
<li>If there&#x27;s a non-empty domain block in the challenge period, the operator will continue the following step to produce an empty bundle to derive the non-empty domain block out of the challenge period (accelerate confirmation time)</li>
</ol>
</li>
<li>
<p>Compute the <code>bundle_extrinsics_root</code> and attach to the header.</p>
</li>
<li>
<p>Compute the <code>bundle_size</code> and <code>estimated_bundle_weight</code>.</p>
</li>
<li>
<p>Note the storage fees to be paid to the consensus block author as per <a href="/protocol-specs/docs/fees_and_rewards#bundle-storage-fees">Bundle Storage Fees</a></p>
</li>
<li>
<p>Sign the bundle header.</p>
</li>
<li>
<p>Build the bundle header as <a href="/protocol-specs/docs/decex/bundles_blocks#bundle-header">described</a>.</p>
</li>
<li>
<p>Broadcast the full bundle over the consensus network.</p>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-selection-for-bundle-production">Transaction Selection for Bundle Production<a href="#transaction-selection-for-bundle-production" class="hash-link" aria-label="Direct link to Transaction Selection for Bundle Production" title="Direct link to Transaction Selection for Bundle Production">​</a></h2>
<div class="collapsible"><button class="collapsible-toggle">►<!-- --> <!-- -->Note</button><div class="collapsible-content"></div></div>
<p>When an operator is elected to produce a bundle, they must select transactions to be included in that bundle according to their transaction pool range (<code>TX_RANGE</code>), as follows:</p>
<ol>
<li>Compute <code>slot_vrf_hash</code> for this slot as <code>hash(vrf_signature.output)</code></li>
<li>Identify txs for inclusion into the bundle for this slot by looking into the transaction pool and identify all transactions whose senders <code>account_id</code> (as integer), is within the range as <code>bidirectional_distance(slot_vrf_hash, public_key_hash) &lt;= TX_RANGE/2</code></li>
</ol>
<p>The operator may only include as many transactions within this range as fit within the bundle <code>max_bundle_weight</code> and <code>max_bundle_size</code> <a href="/protocol-specs/docs/decex/bundles_blocks#bundle-limits">limits</a> for this domain.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="initial-domain-bundle-verification-by-consensus-nodes">Initial Domain Bundle Verification by Consensus Nodes<a href="#initial-domain-bundle-verification-by-consensus-nodes" class="hash-link" aria-label="Direct link to Initial Domain Bundle Verification by Consensus Nodes" title="Direct link to Initial Domain Bundle Verification by Consensus Nodes">​</a></h2>
<p>All consensus nodes will perform the following verification when a new bundle is received over the network. All valid bundles are added to the local extrinsics pool and propagated to all peers on the network. Any invalid bundles are not added to the pool (no fraud proofs for invalid bundles received, only fraud proofs for invalid bundles that are included in a block).</p>
<ol>
<li>Ensure <code>HeadDomainNumber - HeadReceiptNumber = 1</code> otherwise <code>submit_receipt</code> is expected instead of <code>submit_bundle</code></li>
<li>Verify the <code>domain_id</code> is in the <code>DomainRegistry</code>.</li>
<li>Verify the <code>ProofOfElection</code> for this domain and operator.<!-- -->
<ol>
<li>Ensure the <code>slot_number</code> is no older than the slot of the block <code>current_block_number - BundleLongevity</code>.</li>
<li>Verify the <code>slot_number</code> and the <code>proof_of_time</code> is correctly computed.</li>
<li>Verify the <code>vrf_signature</code> based on the operator signing key and the global challenge that is derived from the <code>slot_number</code> and the <code>proof_of_time</code>.</li>
<li>Verify the <code>vrf_signature</code> is below the threshold that is derived from the <code>operator_stake / total_domain_stake</code> and the <code>bundle_slot_probability</code>.</li>
</ol>
</li>
<li>Verify the bundle header <code>signature</code> for the registered domain operator.</li>
<li>Ensure the bundle does not exceed the bundle <code>max_bundle_weight</code> and <code>max_bundle_size</code> <a href="/protocol-specs/docs/decex/bundles_blocks#bundle-limits">limits</a> for this domain.</li>
<li>Ensure the bundle is well-formed:<!-- -->
<ol>
<li>Verify the <code>execution_trace_root</code> is correctly computed for the <code>execution_trace</code>.</li>
<li>Verify the <code>bundle_extrinsics_root</code> is correctly computed for all included extrinsics.</li>
<li>Verify the <code>bundle_size</code> and <code>estimated_bundle_weight</code> were correctly computed for the bundle body.</li>
</ol>
</li>
<li>Ensure the <code>ExecutionReceipt</code> builds on the head of current <code>BlockTree</code> for this domain.<!-- -->
<ol>
<li>Verify <code>domain_block_number</code> is equal to:<!-- -->
<ul>
<li><code>HeadReceiptNumber + 1</code> if this is the first bundle of the domain in the block</li>
<li>or <code>HeadReceiptNumber</code> since <code>HeadReceiptNumber</code> is increased by the previous bundle in the block</li>
</ul>
</li>
<li>Verify the <code>consensus_block_hash</code> exists at the specified <code>consenus_block_height</code> on the consensus client.</li>
<li>Based on <code>parent_domain_receipt_hash</code>, verify the <code>parent_domain_block</code> exists at the specified <code>parent_domain_height</code> within the <code>BlockTree</code> on the operator client. If the ER is beyond the <code>BlockTreePruningDepth</code> it is too old and will simply be ignored.</li>
<li>Verify all <code>block_extrinsics_roots</code> exist within the <code>execution_inbox</code> of the <code>parent_domain_block</code>.</li>
</ol>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bundle-equivocation">Bundle Equivocation<a href="#bundle-equivocation" class="hash-link" aria-label="Direct link to Bundle Equivocation" title="Direct link to Bundle Equivocation">​</a></h3>
<p>A dishonest operator may produce multiple bundles on the same slot with the same proof-of-election. Similar to <a href="https://github.com/paritytech/substrate/blob/689da495a0c0c0c2466fe90a9ea187ce56760f2d/client/consensus/slots/src/aux_schema.rs#L53" target="_blank" rel="noopener noreferrer">how consensus block equivocation is addressed</a>, consensus chain nodes perform a check to determine if a bundle has been equivocated when verifying its validity. If an equivocation is detected, then this bundle is invalid, and is not included in the block.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="consensus-block-verification">Consensus Block Verification<a href="#consensus-block-verification" class="hash-link" aria-label="Direct link to Consensus Block Verification" title="Direct link to Consensus Block Verification">​</a></h2>
<p>On receipt of a new consensus block, each consensus node now needs to check to ensure all included bundle headers were pre-validated locally. If they see a new bundle, they will request and run validation. If that bundle is invalid or any previously invalidated bundles are included in the farmer block, it is simply discarded and ignored.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bundle-header-application">Bundle Header Application<a href="#bundle-header-application" class="hash-link" aria-label="Direct link to Bundle Header Application" title="Direct link to Bundle Header Application">​</a></h2>
<p>On execution of a new consensus block, all included bundles will be applied to the state of <code>pallet_domains</code> as each included bundle header will call <code>submit_bundle</code>.</p>
<p>For each new bundle, each consensus node will:</p>
<div class="collapsible"><button class="collapsible-toggle">►<!-- --> <!-- -->Only accept the bundles pointing to the last consensus block number from which a domain block is derived.</button><div class="collapsible-content"></div></div>
<ol>
<li>Extract the <code>ExecutionReceipt</code></li>
<li>Retrieve the <code>parent_domain_block</code> from the <code>BlockTree</code> and conditionally update the tree. If the parent does not exist within the tree, this <code>ExecutionReceipt</code> has just expired (rare event) and is simply ignored.</li>
<li>If this is a new ER, we will extend the <code>BlockTree</code>. If no fraud has occurred, it will extend the tip of the longest branch.<!-- -->
<ol>
<li>Add a new layer to the tree, inserting the ER as the first entry as a new <code>DomainBlock</code>.</li>
<li>Add the <code>bundle_extrinsics_root</code> to the <code>execution_inbox</code></li>
<li>Add the <code>operator_id</code> to the <code>operator_ids</code> who submitted this ER</li>
<li>Apply XDM coin transfers to the domain’s balance</li>
<li>Apply all operator fees from the ER for the domain block for which the challenge period has now passed:<!-- -->
<ul>
<li>The compute fees should be divided equally between all operators in the <code>operator_ids</code> field for the parent <code>DomainBlock</code> in the <code>BlockTree</code>.</li>
<li>The compute fees are automatically staked and subtracted from domain’s balance.</li>
<li>The storage fees should be refunded to the bundle authors of bundles included in the confirmed block. These should be applied individually to their <code>current_epoch_reward</code> in the <code>OperatorPool</code></li>
</ul>
</li>
</ol>
</li>
<li>Otherwise, reject the receipt that tries to create new branch in the block tree. If fraud has occurred, a new branch will not be created. Instead, the system requires the submission of a fraud proof to prune the fraudulent ER at the specific height before any new ER can be submitted at that height. Fraud verification is not handled here as the consensus node cannot determine which (or all) <code>ExecutionReceipt</code> is actually fraudulent at this level. It is implied that an honest operator will eventually submit a fraud proof to address the issue before submitting new ER. If the fraud proof for the receipt already present in the block tree has already been seen, then it&#x27;s operators are marked as pending slashing and the new receipt will create a new head as described in step 3.</li>
<li>If this ER has already been seen, we will be confirming an existing entry within the block tree. Retrieve the existing <code>DomainBlock</code> from the <code>BlockTree</code>
<ol>
<li>
<p>If this is the tip of <code>BlockTree</code></p>
<ul>
<li>Add the <code>bundle_extrinsics_root</code> to the <code>execution_inbox</code></li>
<li>Add the <code>operator_id</code> to the <code>operator_ids</code></li>
</ul>
</li>
<li>
<p>If this is not the tip of the block tree and we have a stale ER, it is directly rejected and not included in the BlockTree at all.</p>
<div class="collapsible"><button class="collapsible-toggle">►<!-- --> <!-- -->Note</button><div class="collapsible-content"></div></div>
</li>
</ol>
</li>
<li>If any domain block reached <code>BlockTreePruningDepth</code>, then we confirm it:<!-- -->
<ol>
<li>refund the bundle storage fees;</li>
<li>distribute the operator rewards;</li>
<li>mark as pending slash the operators whose bundles this receipt marked as <a href="/protocol-specs/docs/decex/fraud_proofs#invalid-bundle">invalid</a>;</li>
<li>if <code>StakeEpochDuration</code> has passed, do <a href="#domain-epoch-transition">epoch transition</a>.</li>
</ol>
</li>
<li>Slash any operators (and their nominators) who are pending slash, but not more than <code>MAX_NOMINATORS_TO_SLASH</code> at a time.</li>
<li>Accept this bundle as successful and awaiting execution on the domain.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="domain-epoch-transition">Domain Epoch Transition<a href="#domain-epoch-transition" class="hash-link" aria-label="Direct link to Domain Epoch Transition" title="Direct link to Domain Epoch Transition">​</a></h2>
<p>A domain staking epoch is an interval of blocks during which staking distribution remains the same. It is important to ensure a correct and provable @Bundle Producer Election that is not influenced short-term by deposits, withdrawals, and earned fees. This StakeEpochDuration period is currently set to 100 blocks, or roughly 10 minutes. The end of each epoch triggers a series of events to transition to the next epoch. These events include:</p>
<ul>
<li>allocation of fees earned for the blocks confirmed (older than BlockTreePruningDepth) during the epoch,</li>
<li>deposits and withdrawals of stake,</li>
<li>operator registrations and deregistrations,</li>
<li>recalculation of stake distribution for the slot leader VRF election.</li>
</ul>
<p>An epoch transition occurs after every <code>StakeEpochDuration</code> blocks (or when forced in a <code>force_staking_epoch_transition(domain_id)</code><a href="/protocol-specs/docs/decex/interfaces#force_staking_epoch_transition">extrinsic</a>) after all new bundles in the last block have been executed. During the domain epoch transition, we do the following steps:</p>
<ol>
<li>
<p>Re-stake operators’ nomination taxes on their rewards</p>
<ul>
<li>Each operator will get a cut of <code>nomination_tax * current_epoch_fees</code> of all rewards issued to their pool as per <code>nomination_tax</code> specified in the operator’s config.</li>
<li>The operator’s cut will be automatically re-staked to the operator’s nomination as a deposit. Operator’s <code>shares</code>, <code>current_total_shares</code> and <code>current_total_stake</code> will be updated with the corresponding deposit later when deposits are processed.</li>
<li>The <code>current_epoch_fees</code> is temporarily updated to <code>current_epoch_fees*(1-nomination_tax)</code> for the rest of the calculations during the epoch transitions. It will be reset to 0 for the new epoch.</li>
</ul>
</li>
<li>
<p>If there are any operators pending slash, remove their stake from the VRF election for the next epoch.</p>
</li>
<li>
<p>Finalize domain’s staking summary.</p>
<p>For each operator operating on the next epoch (existing and new operators), do the following:</p>
<ol>
<li>
<p>Update the stake with received fees <code>total_stake = current_total_stake + current_epoch_fees</code></p>
</li>
<li>
<p><code>OperatorEpochSharePrice</code> storage is updated with new share price (which excludes the collected nomination tax).</p>
<p><code>share_price = (current_total_stake + current_epoch_fees) / total_shares</code></p>
</li>
<li>
<p>Compute how much to reduce the stake corresponding to all <code>withdrawals_in_epoch</code> unstaked shares <code>total_stake=total_stake-withdrawals_in_epoch/share_price</code></p>
</li>
<li>
<p>Compute how much to increase the stake corresponding to all <code>deposits_in_epoch</code> as <code>total_stake=total_stake+deposits_in_epoch*share_price</code></p>
</li>
<li>
<p>Set <code>current_total_stake</code> and <code>current_total_shares</code> to newly computed values and <code>deposits_in_epoch</code>, <code>withdrawals_in_epoch</code> and <code>current_epoch_fees</code> to 0.</p>
</li>
</ol>
</li>
</ol>
<p>As soon as the end of the epoch transition is finalized, the next epoch begins.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="domain-block-production">Domain Block Production<a href="#domain-block-production" class="hash-link" aria-label="Direct link to Domain Block Production" title="Direct link to Domain Block Production">​</a></h2>
<p>The domain block is deterministically driven from the consensus block and always follows the <a href="#fork-choice-rule">fork choice</a> of the consensus chain.</p>
<p>The operator subscribes to the consensus block import notification, and for each imported consensus block the operator tries to build a domain block of defined <a href="/protocol-specs/docs/decex/bundles_blocks#domain-blocks">structure</a> by constructing the following components:</p>
<p><strong>Block Body</strong></p>
<ol>
<li>Extract the bundles of the domain, which the operator registered, from the consensus block and extract the extrinsics from the bundles.<!-- -->
<ol>
<li>If there is no bundle, skip producing domain block for this consensus block</li>
</ol>
</li>
<li>Extrinsics will be ordered as described in <a href="#cryptographic-sortition-for-extrinsic-ordering">Cryptographic sortition for Extrinsic ordering</a></li>
<li>The resulting extrinsics will be used as the block body</li>
</ol>
<p><strong>Extrinsics Root</strong></p>
<p>Merkle tree root of the extrinsics</p>
<p><strong>State Root</strong></p>
<ol>
<li>Execute the block body by following the instructions mentioned at <a href="#domain-block-execution-on-the-operator-node">Domain Block Execution on the Operator Node</a></li>
<li>The state root after execution will be used as the state root in the block header</li>
</ol>
<p><strong>Parent Block</strong></p>
<p>The parent block should be the last domain block that drives from the same branch as the incoming consensus block following the consensus chain <a href="#fork-choice-rule">Fork Choice Rule</a></p>
<ul>
<li>
<p><em>Example</em></p>
<p>Consensus chain:  <code>.. → b1 → b2 → b3 → b4</code> , <code>b4</code> is the incoming consensus block that the operator trying to drive a domain block, while <code>b2</code> and <code>b3</code> didn’t drive a domain block due to not bundle contains inside them, the last domain block of this branch is the one driving from <code>b1</code> thus it will be used as parent block of the domain block driving from <code>b4</code></p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cryptographic-sortition-for-extrinsic-ordering">Cryptographic sortition for Extrinsic ordering<a href="#cryptographic-sortition-for-extrinsic-ordering" class="hash-link" aria-label="Direct link to Cryptographic sortition for Extrinsic ordering" title="Direct link to Cryptographic sortition for Extrinsic ordering">​</a></h3>
<ol>
<li>Deduplicate extrinsics.</li>
<li>Group the signed extrinsics by sender <code>account_id</code>, and unsigned extrinsics into a separate group.</li>
<li>Use the consensus chain <code>Randomness</code> derived from PoT as <code>extrinsics_shuffling_seed</code>.</li>
<li>Shuffle the grouped extrinsics using the Fisher–Yates algorithm based on the <code>extrinsics_shuffling_seed</code>.
This generates an unbiased and deterministic permutation, while relative ordering for the transactions for the same sender does not change.</li>
</ol>
<ul>
<li>
<p><em>Example</em></p>
<p>Before grouping:<code>(Alice, 1), (-, 1), (Bob, 1), (Bob, 2), (Alice,2), (Charlie, 1), (Alice,3), (Charlie, 2), (-,2), (-,3)</code> <code>(-)</code> for unsigned</p>
<p>After grouping: <code>(Alice, 1), (Alice,2), (Alice,3), (Bob, 1), (Bob, 2), (Charlie, 1), (Charlie, 2), (-, 1), (-,2), (-,3)</code></p>
<p>After shuffle: <code>(-, 1), (Charlie, 1), (Alice, 1), (Bob, 1), (Alice,2), (-,2), (Charlie, 2), (Alice,3), (-,3), (Bob, 2)</code></p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fork-choice-rule">Fork Choice Rule<a href="#fork-choice-rule" class="hash-link" aria-label="Direct link to Fork Choice Rule" title="Direct link to Fork Choice Rule">​</a></h3>
<p>The consensus chain uses <a href="https://github.com/subspace/subspace/blob/b72d865aa776f3088e37808c02c1468333e213d8/crates/sc-consensus-subspace/src/lib.rs#L1154-L1155" target="_blank" rel="noopener noreferrer">the heaviest chain rule</a> (i.e., smallest solution range) if forks have the same weight go with the longest one, while the domain chain always follows the fork choice of the consensus chain regardless of whether the domain fork is the longest fork or not.</p>
<p>Consensus chain (assume every block has the same weight):</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">     b2 → b3 → b4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">→ a1 → a2 → a3 → a4 → a5 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Given domain chain, the consensus block <code>a3</code> and <code>a4</code> don’t contain bundles thus there is no domain block driving from them:</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">            domain_b2 → domain_b3 → domain_b4</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token operator">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">→ domain_a1 → domain_a2 → domain_a5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The best fork of the consensus chain is fork A as it is the longest fork, and the domain chain always follows the fork choice of the consensus chain thus its best fork is also fork A even though it is not the longest fork.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="domain-block-execution-on-the-operator-node">Domain Block Execution on the Operator Node<a href="#domain-block-execution-on-the-operator-node" class="hash-link" aria-label="Direct link to Domain Block Execution on the Operator Node" title="Direct link to Domain Block Execution on the Operator Node">​</a></h2>
<p>The main distinction between domain block execution and normal Substrate block execution lies in the calculation and collection of the storage root after completing each execution phase (<code>InitializeBlock</code>, <code>ApplyExtrinsic</code>, <code>FinalizeBlock</code>). The storage roots collected during the process create an execution trace. This trace is then utilized to identify precise computational discrepancies within the fraud proof.</p>
<p>In Substrate, there is a trait <a href="https://paritytech.github.io/substrate/master/frame_support/traits/trait.Hooks.html" target="_blank" rel="noopener noreferrer"><code>Hooks</code></a> that each pallet can implement to execute some logic during the block execution, the related hooks here are <code>on_initialize</code> and <code>on_finalize</code>. A block with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span> extrinsics in Substrate is primarily executed as follows:</p>
<ol>
<li>
<p><a href="https://github.com/paritytech/substrate/blob/689da495a0c0c0c2466fe90a9ea187ce56760f2d/frame/executive/src/lib.rs#L396" target="_blank" rel="noopener noreferrer">Initialization</a> <code>initialize_block(header)</code></p>
<ol>
<li>Execute the <code>on_runtime_upgrade</code> hooks if the runtime has been upgraded</li>
<li>Initialize <a href="https://github.com/paritytech/substrate/tree/master/frame/system" target="_blank" rel="noopener noreferrer">System module</a> pallet</li>
<li>Execute the <code>on_initialize</code> hook of all non-system pallets</li>
</ol>
<p>After executing <code>initialize_block</code>, we calculate the first state root as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>o</mi><mi>o</mi><msub><mi>t</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">Root_{0}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">oo</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></p>
</li>
<li>
<p>Execute the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span> extrinsics one by one using <code>apply_extrinsic(uxt)</code> <a href="https://github.com/paritytech/substrate/blob/689da495a0c0c0c2466fe90a9ea187ce56760f2d/frame/executive/src/lib.rs#L549" target="_blank" rel="noopener noreferrer">method</a></p>
<ol>
<li>Apply extrinsic 0 ⇒ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>o</mi><mi>o</mi><msub><mi>t</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">Root_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">oo</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></li>
<li>Apply extrinsic 1 ⇒ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>o</mi><mi>o</mi><msub><mi>t</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">Root_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">oo</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></li>
<li>…</li>
<li>Apply extrinsic <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span>-1 ⇒ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>o</mi><mi>o</mi><msub><mi>t</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">Root_{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">oo</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></li>
</ol>
<p>After executing each extrinsic, we calculate the state root as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>o</mi><mi>o</mi><msub><mi>t</mi><mrow><mo stretchy="false">{</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">}</mo></mrow></msub></mrow><annotation encoding="application/x-tex">Root_{\{1, 2, .., n\}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">oo</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">{</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mpunct mtight">,</span><span class="mord mtight">..</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">}</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em"><span></span></span></span></span></span></span></span></span></span></p>
</li>
<li>
<p><a href="https://github.com/paritytech/substrate/blob/689da495a0c0c0c2466fe90a9ea187ce56760f2d/frame/executive/src/lib.rs#L515" target="_blank" rel="noopener noreferrer">Finalization</a> <code>finalize_block()</code></p>
<ol>
<li>Execute <code>on_idle</code> hook if there are still some weights remaining</li>
<li>Execute the <code>on_finalize</code> hook of all non-system pallets</li>
<li>Finalize system pallet</li>
</ol>
<p>After executing <code>finalize_block()</code>, we calculate the state root as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>o</mi><mi>o</mi><msub><mi>t</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">Root_{ n+1 }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">oo</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em"><span></span></span></span></span></span></span></span></span></span>.</p>
</li>
</ol>
<p>Therefore, the execution trace for a block with  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">n</span></span></span></span> extrinsics is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>R</mi><mi>o</mi><mi>o</mi><msub><mi>t</mi><mn>0</mn></msub><mo separator="true">,</mo><mi>R</mi><mi>o</mi><mi>o</mi><msub><mi>t</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>R</mi><mi>o</mi><mi>o</mi><msub><mi>t</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[Root_{0}, Root_{1}, …, Root_{n+1}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">oo</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">oo</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">oo</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="domain-sudo">Domain Sudo<a href="#domain-sudo" class="hash-link" aria-label="Direct link to Domain Sudo" title="Direct link to Domain Sudo">​</a></h2>
<p>Domains have a modified pallet to provide sudo call. The Sudo is triggerred from the Consensus chain and then executed in the Domain block.
<code>pallet_domain_sudo</code> has a inherent extrinsic that is created and imported into Domain block if the Consensus block from which Domain block is created
from contains a Sudo Call for the targetted Domain. Only one sudo call is allowed per domain block. Multiple Call can be achieved using <code>pallet_utility::BatchAll</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="flow-to-execute-a-sudo-call-on-domain">Flow to execute a Sudo call on Domain.<a href="#flow-to-execute-a-sudo-call-on-domain" class="hash-link" aria-label="Direct link to Flow to execute a Sudo call on Domain." title="Direct link to Flow to execute a Sudo call on Domain.">​</a></h3>
<ul>
<li>Sudo on Consensus chain will submit an encoded unsigned domain extrinsic to <code>pallet_domains::Call::send_domain_sudo_call</code></li>
<li>If the targetted domain has the <code>pallet_domain_sudo</code> enabled, then the encoded call is stored.<!-- -->
<ul>
<li>Note: This storage is cleared on Consensus chain when there is a Successful bundle submission from the Domain.</li>
</ul>
</li>
<li>When domain operators are deriving a Domain Block from a given Consensus block, they check <code>pallet_domains::domain_sudo_call(domain_id)</code> if there is any sudo call.</li>
<li>If so, they will inject this Domain sudo Call as an Inherent extrinsic and executes the Domain block.<!-- -->
<ul>
<li>Note: <code>pallet_domain_sudo</code> executed the provided the encoded domain call with <code>Root</code> origin.</li>
</ul>
</li>
</ul>
<p>Since <code>pallet_domain_sudo</code> provides an Unsigned extrinsic, if this extrinsic is manually constructed and included in the Domain Block, it will trigger
<code>FraudProof::InherentExtrinsic</code> from the honest operators.</p>
<p>This inherent extrinsic also affects the <code>FraudProof::InvalidDomainExtrinsicRoot</code> if any malicious operator does not include this inherent while importing Domain block.
Honest operators will submit above FraudProof variant with all the necessary storage proofs to construct the Domain Extrinsic root.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lagging-operator-protection">Lagging operator protection<a href="#lagging-operator-protection" class="hash-link" aria-label="Direct link to Lagging operator protection" title="Direct link to Lagging operator protection">​</a></h2>
<p>In a distributed system, it is inevitable that some nodes may be lagging (e.g. due to network partition or slow hardware). This is critical for the operator node because when it produces a bundle, it needs to verify and guarantee all the extrinsic included in the bundle is valid. When the domain node tries to derive a new domain block from the bundles included in the consensus block, it will also verify all the extrinsic against the latest domain block (i.e. the parent domain block of the new block), if there is any invalid extrinsic found the whole bundle will be marked as invalid and the operator who produced this bundle will be slashed.</p>
<p>For a lagging operator, it is possible that when producing a bundle it verifies the extrinsic against an old domain block, and the extrinsic turns out to be invalid when other domain nodes verify it against the latest domain block, as a result, an honest but lagging operator will be slashed.</p>
<p>To protect the lagging operator, the consensus node when verifying the bundle will check the bundle contains an execution receipt that is derived from the latest domain block, which means the producer is not lagging, if it is not then the bundle will not be included in the consensus block so the operator won&#x27;t be slashed.</p>
<p>The consensus node when performing this check also needs to ensure the execution receipt is extending the previous head receipt, this means if there is a gap between the latest domain block (i.e. <code>HeadDomainNumber</code>) and the latest receipt on chain (i.e. <code>HeadReceiptNumber</code>), which usually happen after a fraud proof is accepted and bad receipts were pruned, any bundle will be rejected. In this case, the operator needs to produce <code>submit_receipt</code> to fill up the gap and after that they can resume producing <code>submit_bundle</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="domain-freeze-unfreeze-and-prune-execution-receipt-by-consensus-sudo">Domain Freeze, Unfreeze, and Prune Execution Receipt by Consensus Sudo<a href="#domain-freeze-unfreeze-and-prune-execution-receipt-by-consensus-sudo" class="hash-link" aria-label="Direct link to Domain Freeze, Unfreeze, and Prune Execution Receipt by Consensus Sudo" title="Direct link to Domain Freeze, Unfreeze, and Prune Execution Receipt by Consensus Sudo">​</a></h2>
<p>Generally, malicious activity from a domain operator is handled through Fraud proofs where honest operators verify the bundles before importing domain block and submit
Fraud proof targeted at given bad Execution receipt. In a particular case where Fraud proof could not be verified automatically or included in the
Consensus block, the bad ER never gets pruned and given enough time, it may even go out of challenge period.</p>
<p>In order to safe-guard against such an attack, Sudo on Consensus has the ability to Freeze, Unfreeze, and prune execution receipt of a domain.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">pallet_domains::Call::freeze_domain(domain_id)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pallet_domains::Call::unfreeze_domain(domain_id)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pallet_domains::Call::prune_execution_receipt(domain_id, bad_er_hash)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The prune execution receipt dispatch makes an assumption that Sudo has validated the invalidity of the bad ER by verifying it offchain and/or through social consensus
if the Governance is at play.</p>
<p>Note: Domain must be frozen to stop accepting new bundles before pruning a execution receipt.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/protocol-specs/docs/decex/bundles_blocks"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Bundles and Domain Blocks</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/protocol-specs/docs/decex/staking"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Staking</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#domain-instantiation--upgrades" class="table-of-contents__link toc-highlight">Domain Instantiation &amp; Upgrades</a></li><li><a href="#domain-instance-genesis-block-generation" class="table-of-contents__link toc-highlight">Domain Instance Genesis Block Generation</a></li><li><a href="#domain-instance-node-bootstrap" class="table-of-contents__link toc-highlight">Domain Instance Node Bootstrap</a></li><li><a href="#domain-genesis-config" class="table-of-contents__link toc-highlight">Domain Genesis Config</a></li><li><a href="#domain-runtime-upgrades" class="table-of-contents__link toc-highlight">Domain Runtime Upgrades</a></li><li><a href="#bundle-producer-election" class="table-of-contents__link toc-highlight">Bundle Producer Election</a></li><li><a href="#domain-bundle-production" class="table-of-contents__link toc-highlight">Domain Bundle Production</a></li><li><a href="#transaction-selection-for-bundle-production" class="table-of-contents__link toc-highlight">Transaction Selection for Bundle Production</a></li><li><a href="#initial-domain-bundle-verification-by-consensus-nodes" class="table-of-contents__link toc-highlight">Initial Domain Bundle Verification by Consensus Nodes</a><ul><li><a href="#bundle-equivocation" class="table-of-contents__link toc-highlight">Bundle Equivocation</a></li></ul></li><li><a href="#consensus-block-verification" class="table-of-contents__link toc-highlight">Consensus Block Verification</a></li><li><a href="#bundle-header-application" class="table-of-contents__link toc-highlight">Bundle Header Application</a></li><li><a href="#domain-epoch-transition" class="table-of-contents__link toc-highlight">Domain Epoch Transition</a></li><li><a href="#domain-block-production" class="table-of-contents__link toc-highlight">Domain Block Production</a><ul><li><a href="#cryptographic-sortition-for-extrinsic-ordering" class="table-of-contents__link toc-highlight">Cryptographic sortition for Extrinsic ordering</a></li><li><a href="#fork-choice-rule" class="table-of-contents__link toc-highlight">Fork Choice Rule</a></li></ul></li><li><a href="#domain-block-execution-on-the-operator-node" class="table-of-contents__link toc-highlight">Domain Block Execution on the Operator Node</a></li><li><a href="#domain-sudo" class="table-of-contents__link toc-highlight">Domain Sudo</a><ul><li><a href="#flow-to-execute-a-sudo-call-on-domain" class="table-of-contents__link toc-highlight">Flow to execute a Sudo call on Domain.</a></li></ul></li><li><a href="#lagging-operator-protection" class="table-of-contents__link toc-highlight">Lagging operator protection</a></li><li><a href="#domain-freeze-unfreeze-and-prune-execution-receipt-by-consensus-sudo" class="table-of-contents__link toc-highlight">Domain Freeze, Unfreeze, and Prune Execution Receipt by Consensus Sudo</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Subspace Network</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://subspace.network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Website<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/subspace/subspace-desktop" target="_blank" rel="noopener noreferrer" class="footer__link-item">Subspace Desktop<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://polkadot.js.org/apps/?rpc=wss%3A%2F%2Ftest-rpc.subspace.network#/explorer" target="_blank" rel="noopener noreferrer" class="footer__link-item">Subspace Explorer<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://testnet-relayer.subspace.network/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Subspace Relayer<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/subspace" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/subspace-network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/subspace_network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/channel/UCojYRCZOtVTJHJXivOYJzeQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/subspace-blockchain" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/network_subspace" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://medium.com/subspace-network" target="_blank" rel="noopener noreferrer" class="footer__link-item">Medium<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://app.subsocial.network/@NetworkSubspace" target="_blank" rel="noopener noreferrer" class="footer__link-item">Subsocial<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://subspace.network" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/protocol-specs/img/banner-black.svg" alt="Subspace Labs Banner Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src="/protocol-specs/img/banner-white.svg" alt="Subspace Labs Banner Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class="footer__copyright">Copyright © 2024 Subspace Labs, Inc.</div></div></div></footer></div>
</body>
</html>